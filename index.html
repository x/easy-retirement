<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Retirement Calculator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="app.css">
    <style>
        [x-cloak] { display: none !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body>
    <main class="container" x-data="retirementCalculator()" x-cloak>
        <h1>Easy Retirement Calculator</h1>
        <p>Calculate your years until retirement based on your savings rate</p>
        <article>

            <div>
                <label for="savings-rate">
                    Savings Rate
                    <div class="input-group has-suffix">
                        <input type="number" id="savings-rate" x-model.number.debounce.150ms="savingsRatePercent"
                            min="1" max="100" step="1" placeholder="15" aria-label="Percent"
                            :aria-invalid="savingsRatePercent > 0 && savingsRatePercent <= 100 ? 'false' : 'true'">
                        <span class="suffix">%</span>
                    </div>
                </label>
                <small>What percentage of your post-tax income do you save?</small>
            </div>

            <details>
                <summary>Advanced Settings</summary>

                <fieldset>
                    <legend>Income (for dollar-based calculations)</legend>
                    <div class="grid">
                        <label>
                            Annual Pre-Tax Income
                            <div class="input-group has-prefix">
                                <span class="prefix">$</span>
                                <input type="number" x-model.number.debounce.150ms="preTaxIncome" min="0" step="1000"
                                    placeholder="100000" aria-label="Dollar amount">
                            </div>
                        </label>
                        <label>
                            Tax Rate
                            <div class="input-group has-suffix">
                                <input type="number" x-model.number.debounce.150ms="taxRatePercent" min="0" max="100"
                                    step="0.1" :placeholder="estimatedTaxRate.toFixed(1)" aria-label="Percent">
                                <span class="suffix">%</span>
                            </div>
                        </label>
                    </div>

                    <label>
                        <input type="checkbox" x-model="filingJointly">
                        Filing jointly (married)
                    </label>

                    <small x-show="preTaxIncome > 0" x-text="postTaxIncomeText"></small>
                </fieldset>

                <fieldset>
                    <legend>Current Financial Position</legend>
                    <div class="grid">
                        <label>
                            Already Saved
                            <div class="input-group has-prefix">
                                <span class="prefix">$</span>
                                <input type="number" x-model.number.debounce.150ms="alreadySaved" min="0" step="1000"
                                    placeholder="0" aria-label="Dollar amount">
                            </div>
                        </label>
                        <label>
                            Current Debt
                            <div class="input-group has-prefix">
                                <span class="prefix">$</span>
                                <input type="number" x-model.number.debounce.150ms="currentDebt" min="0" step="1000"
                                    placeholder="0" aria-label="Dollar amount">
                            </div>
                        </label>
                    </div>
                    <small x-show="calculatedPostTaxIncome > 0 && (alreadySaved > 0 || currentDebt > 0)">
                        Net position: <strong x-text="netPositionText"></strong>
                    </small>
                    <small x-show="calculatedPostTaxIncome === 0 && (alreadySaved > 0 || currentDebt > 0)"
                        style="color: var(--pico-del-color);">
                        Enter your income above to see position as a multiple of annual income
                    </small>
                </fieldset>

                <fieldset>
                    <legend>Retirement Assumptions</legend>
                    <div class="grid">
                        <label>
                            Expected Rate of Return
                            <div class="input-group has-suffix">
                                <input type="number" x-model.number.debounce.150ms="rateOfReturnPercent" min="0"
                                    max="20" step="0.1" placeholder="5" aria-label="Percent">
                                <span class="suffix">%</span>
                            </div>
                        </label>
                        <label>
                            Retirement Multiplier
                            <div class="input-group has-suffix">
                                <input type="number" x-model.number.debounce.150ms="retirementMultiplier" min="1"
                                    max="50" step="1" placeholder="25" aria-label="Times">
                                <span class="suffix">Ã—</span>
                            </div>
                        </label>
                    </div>
                    <small>Based on the 4% rule (25x = 4% withdrawal rate)</small>
                </fieldset>
            </details>

            <footer>
                <h2 x-text="yearsText"></h2>
                <p x-show="isValid" x-text="explanation"></p>
                <p x-show="!isValid" style="color: var(--pico-del-color);">
                    Please enter a savings rate between 1% and 100%
                </p>
                <div x-show="isValid" style="margin-top: 2rem;">
                    <canvas x-ref="retirementChart"></canvas>
                </div>
            </footer>
        </article>
    </main>

    <script>
        function retirementCalculator() {
            return {
                // Primary input
                savingsRatePercent: 15,

                // Income inputs (optional, for dollar-based calculations)
                preTaxIncome: null,
                taxRatePercent: null,
                filingJointly: false,

                // Financial position (optional)
                alreadySaved: 0,
                currentDebt: 0,

                // Retirement assumptions
                rateOfReturnPercent: 5,
                retirementMultiplier: 25,

                // Tax estimation based on 2024 federal + approximate state (simplified)
                estimateTaxRate(income) {
                    if (!income || income <= 0) return 25; // Default guess

                    if (this.filingJointly) {
                        // Married filing jointly brackets (higher thresholds)
                        if (income <= 22000) return 10;
                        if (income <= 89075) return 15;
                        if (income <= 190750) return 22;
                        if (income <= 364200) return 26;
                        if (income <= 462500) return 30;
                        if (income <= 693750) return 35;
                        return 40;
                    } else {
                        // Single filer brackets
                        if (income <= 11000) return 10;
                        if (income <= 44725) return 15;
                        if (income <= 95375) return 22;
                        if (income <= 182100) return 26;
                        if (income <= 231250) return 30;
                        if (income <= 578125) return 35;
                        return 40;
                    }
                },

                get estimatedTaxRate() {
                    if (this.taxRatePercent) return this.taxRatePercent;
                    return this.estimateTaxRate(this.preTaxIncome || 0);
                },

                get calculatedPostTaxIncome() {
                    if (this.preTaxIncome && this.preTaxIncome > 0) {
                        const taxRate = this.estimatedTaxRate / 100;
                        return this.preTaxIncome * (1 - taxRate);
                    }

                    return 0;
                },

                get postTaxIncomeText() {
                    const postTax = this.calculatedPostTaxIncome;
                    if (postTax > 0) {
                        return `Post-tax income: $${postTax.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
                    }
                    return '';
                },

                get savingsRate() {
                    return (this.savingsRatePercent || 0) / 100;
                },

                get existingSavingsMultiplier() {
                    if (!this.calculatedPostTaxIncome) return 0;
                    const netPosition = (this.alreadySaved || 0) - (this.currentDebt || 0);
                    return netPosition / this.calculatedPostTaxIncome;
                },

                get netPositionText() {
                    const netPosition = (this.alreadySaved || 0) - (this.currentDebt || 0);
                    const multiplier = this.existingSavingsMultiplier;
                    const absMultiplier = Math.abs(multiplier).toFixed(2);

                    if (netPosition >= 0) {
                        return `${absMultiplier}x your annual post-tax income saved`;
                    } else {
                        return `${absMultiplier}x your annual post-tax income in debt`;
                    }
                },

                get rateOfReturn() {
                    return (this.rateOfReturnPercent || 5) / 100;
                },

                get isValid() {
                    return this.savingsRatePercent > 0 && this.savingsRatePercent <= 100;
                },

                get yearsToRetirement() {
                    if (!this.isValid) return 0;

                    const S = this.savingsRate;
                    const r = this.rateOfReturn;
                    const x = this.retirementMultiplier || 25;
                    const existing = this.existingSavingsMultiplier;

                    // Target: x times annual spending = x * (1 - S) times annual income
                    const target = x * (1 - S);

                    // Already saved (in terms of annual income)
                    const alreadySaved = existing;

                    // Still need to save
                    const stillNeeded = target - alreadySaved;

                    // If already at or past target
                    if (stillNeeded <= 0) return 0;

                    // Years needed with compound interest
                    // FV = PV(1+r)^t + PMT * ((1+r)^t - 1) / r
                    // target = existing(1+r)^t + S * ((1+r)^t - 1) / r
                    // Rearranging: t = ln((target * r + S) / (existing * r + S)) / ln(1 + r)

                    const numerator = Math.log((target * r + S) / (existing * r + S));
                    const denominator = Math.log(1 + r);

                    return numerator / denominator;
                },

                get yearsText() {
                    if (!this.isValid) return 'Enter a savings rate between 1% and 100%';

                    const years = this.yearsToRetirement;
                    const roundedYears = Math.round(years * 10) / 10;

                    return `${roundedYears} years until retirement`;
                },

                get explanation() {
                    if (!this.isValid) return '';

                    const years = Math.round(this.yearsToRetirement);
                    const currentYear = new Date().getFullYear();
                    const retirementYear = currentYear + years;

                    if (years === 0) {
                        return `You've already saved enough to retire!`;
                    }

                    let message = `Saving ${this.savingsRatePercent}% of your income`;

                    if (this.existingSavingsMultiplier && Math.abs(this.existingSavingsMultiplier) > 0.01) {
                        const absMultiplier = Math.abs(this.existingSavingsMultiplier).toFixed(1);
                        const savedDesc = this.existingSavingsMultiplier > 0
                            ? `with ${absMultiplier}x your income already saved`
                            : `starting ${absMultiplier}x your income in debt`;
                        message += `, ${savedDesc}`;
                    }

                    message += `, you could retire around ${retirementYear}`;

                    return message;
                },

                generateChartData() {
                    const S = this.savingsRate;
                    const r = this.rateOfReturn;
                    const x = this.retirementMultiplier || 25;
                    const existing = this.existingSavingsMultiplier;
                    const target = x * (1 - S); // Target in multiples of annual spending

                    const maxYears = Math.ceil(this.yearsToRetirement) + 5;
                    const years = [];
                    const savings = [];

                    for (let year = 0; year <= maxYears; year++) {
                        years.push(year);

                        // Calculate savings at this year
                        // Existing savings grow with compound interest: existing * (1+r)^year
                        // Annual savings accumulate: S * ((1+r)^year - 1) / r
                        const compoundedExisting = existing * Math.pow(1 + r, year);
                        const accumulatedSavings = S * (Math.pow(1 + r, year) - 1) / r;
                        const totalSavings = compoundedExisting + accumulatedSavings;

                        // Convert to multiples of annual spending
                        const multiplesOfSpending = totalSavings / (1 - S);
                        savings.push(multiplesOfSpending);
                    }

                    return { years, savings, target };
                },

                initChart() {
                    if (!this.$refs.retirementChart) return;

                    const ctx = this.$refs.retirementChart.getContext('2d');
                    const { years, savings, target } = this.generateChartData();

                    if (this.chart) {
                        this.chart.destroy();
                    }

                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: years,
                            datasets: [{
                                label: 'Savings (multiples of annual spending)',
                                data: savings,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                tension: 0.1,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            aspectRatio: 2,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                annotation: {
                                    annotations: {
                                        fireNumber: {
                                            type: 'line',
                                            yMin: target,
                                            yMax: target,
                                            borderColor: 'rgb(255, 99, 132)',
                                            borderWidth: 2,
                                            borderDash: [5, 5],
                                            label: {
                                                display: true,
                                                content: `FIRE: ${target.toFixed(1)}x`,
                                                position: 'end'
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Years'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Multiples of Annual Spending Saved'
                                    },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },

                init() {
                    this.$nextTick(() => {
                        if (this.isValid) {
                            this.initChart();
                        }
                    });

                    this.$watch('savingsRatePercent', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('rateOfReturnPercent', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('retirementMultiplier', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('existingSavingsMultiplier', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                }
            }
        }
    </script>
</body>

</html>