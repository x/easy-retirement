<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Easy Retirement Calculator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        [x-cloak] {
            display: none !important;
        }

        /* Input prefix/suffix styling */
        .input-group {
            position: relative;
        }

        .input-group input {
            width: 100%;
        }

        .input-group .prefix,
        .input-group .suffix {
            position: absolute;
            color: var(--pico-muted-color);
            pointer-events: none;
            font-size: 1rem;
            /* Match Pico's input height calculation */
            line-height: calc(1rem * var(--pico-line-height) + var(--pico-form-element-spacing-vertical) * 2 + var(--pico-border-width) * 2);
        }

        .input-group .prefix {
            left: var(--pico-form-element-spacing-horizontal);
        }

        .input-group .suffix {
            right: var(--pico-form-element-spacing-horizontal);
        }

        /* Move suffix left when validation icon is present */
        .input-group input[aria-invalid]~.suffix {
            right: calc(var(--pico-form-element-spacing-horizontal) + 1.75rem);
        }

        .input-group.has-prefix input {
            padding-left: calc(var(--pico-form-element-spacing-horizontal) + 1.5rem);
        }

        .input-group.has-suffix input {
            padding-right: calc(var(--pico-form-element-spacing-horizontal) + 1.5rem);
        }

        /* Add extra padding for suffix when validation icon is present */
        .input-group.has-suffix input[aria-invalid] {
            padding-right: calc(var(--pico-form-element-spacing-horizontal) + 3.25rem);
        }

        /* Remove bottom margin from savings rate to tighten spacing */
        #savings-rate {
            margin-bottom: 0;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body>
    <main class="container" x-data="retirementCalculator()" x-cloak>
        <h1>Easy Retirement Calculator</h1>
        <p>Calculate your years until retirement based on your savings rate</p>
        <grid>
            <article>

                <div>
                    <label for="savings-rate">
                        Savings Rate
                        <div class="input-group has-suffix">
                            <input type="number" id="savings-rate" x-model.number.debounce.150ms="savingsRatePercent"
                                min="1" max="100" step="1" placeholder="15" aria-label="Percent"
                                :aria-invalid="savingsRatePercent > 0 && savingsRatePercent <= 100 ? 'false' : 'true'">
                            <span class="suffix">%</span>
                        </div>
                    </label>
                    <small>What percentage of your post-tax income do you save?</small>
                </div>

                <details>
                    <summary style="margin-top: 1rem">Advanced Settings</summary>

                    <div class="grid" style="margin-bottom: 1rem">
                        <label>
                            <input type="checkbox" role="switch" x-model="showLeanFatFire">
                            Lean/Fat FIRE
                        </label>
                        <label>
                            <input type="checkbox" role="switch" x-model="showCoastFire"
                                @change="if(showCoastFire) { $refs.ageDetails.open = true; }">
                            CoastFIRE
                        </label>
                    </div>


                    <fieldset>
                        <legend>Income (for dollar-based calculations)</legend>
                        <div class="grid">
                            <label>
                                Annual Pre-Tax Income
                                <div class="input-group has-prefix">
                                    <span class="prefix">$</span>
                                    <input type="text" x-model="preTaxIncome"
                                        @input="preTaxIncome = parseNumberInput($el.value); $el.value = formatNumberInput(preTaxIncome)"
                                        @blur="$el.value = formatNumberInput(preTaxIncome)" placeholder="100,000"
                                        aria-label="Dollar amount">
                                </div>
                            </label>
                            <label>
                                Tax Rate
                                <div class="input-group has-suffix">
                                    <input type="number" x-model.number.debounce.150ms="taxRatePercent" min="0"
                                        max="100" step="0.1" :placeholder="estimatedTaxRate.toFixed(1)"
                                        aria-label="Percent">
                                    <span class="suffix">%</span>
                                </div>
                            </label>
                        </div>

                        <label>
                            <input type="checkbox" role="switch" x-model="filingJointly">
                            Filing jointly (married)
                        </label>

                        <small x-show="preTaxIncome > 0" x-text="postTaxIncomeText"></small>
                    </fieldset>

                    <fieldset>
                        <legend>Savings & Debt</legend>
                        <div class="grid">
                            <label>
                                Already Saved
                                <div class="input-group has-prefix">
                                    <span class="prefix">$</span>
                                    <input type="text" x-model="alreadySaved"
                                        @input="alreadySaved = parseNumberInput($el.value) || 0; $el.value = formatNumberInput(alreadySaved)"
                                        @blur="$el.value = formatNumberInput(alreadySaved)" placeholder="0"
                                        aria-label="Dollar amount">
                                </div>
                            </label>
                            <label>
                                Current Debt
                                <div class="input-group has-prefix">
                                    <span class="prefix">$</span>
                                    <input type="text" x-model="currentDebt"
                                        @input="currentDebt = parseNumberInput($el.value) || 0; $el.value = formatNumberInput(currentDebt)"
                                        @blur="$el.value = formatNumberInput(currentDebt)" placeholder="0"
                                        aria-label="Dollar amount">
                                </div>
                            </label>
                        </div>
                        <small x-show="calculatedPostTaxIncome > 0 && (alreadySaved > 0 || currentDebt > 0)">
                            Net position: <strong x-text="netPositionText"></strong>
                        </small>
                        <small x-show="calculatedPostTaxIncome === 0 && (alreadySaved > 0 || currentDebt > 0)"
                            style="color: var(--pico-del-color);">
                            Enter your income above to see position as a multiple of annual income
                        </small>
                    </fieldset>

                    <fieldset>
                        <legend>Timeline</legend>
                        <div class="grid">
                            <label>
                                Current Age
                                <input type="number" x-model.number.debounce.150ms="currentAge" min="18" max="100"
                                    step="1" placeholder="30" aria-label="Years">
                            </label>
                            <label>
                                Retirement Age
                                <input type="number" x-model.number.debounce.150ms="retirementAge" min="18" max="100"
                                    step="1" placeholder="65" aria-label="Years">
                            </label>
                        </div>
                        <small x-show="showCoastFire && currentAge && retirementAge">
                            CoastFIRE: Stop saving at <strong x-text="coastFireTarget.toFixed(1) + 'x'"></strong> annual
                            spending and let compound growth reach <strong x-text="retirementMultiplier + 'x'"></strong>
                            by age <span x-text="retirementAge"></span>
                        </small>
                    </fieldset>

                    <fieldset>
                        <legend>Assumptions</legend>
                        <div class="grid">
                            <div>
                                <label>
                                    Retirement Goal
                                    <select x-model="fireStrategy" @change="updateMultiplierFromStrategy()"
                                        style="margin-top: 0rem;">
                                        <option value="lean">LeanFIRE (22x / 4.5%)</option>
                                        <option value="standard" selected>Standard FIRE (25x / 4%)</option>
                                        <option value="fat">FatFIRE (33x / 3%)</option>
                                    </select>
                                </label>
                            </div>
                            <div>
                                <label>
                                    Expected Rate of Return
                                    <div class="input-group has-suffix">
                                        <input type="number" x-model.number.debounce.150ms="rateOfReturnPercent" min="0"
                                            max="20" step="0.1" placeholder="5" aria-label="Percent">
                                        <span class="suffix">%</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        <small>
                            <span x-show="fireStrategy === 'lean'">Lower spending lifestyle, 4.5% withdrawal rate</span>
                            <span x-show="fireStrategy === 'standard'">Based on the 4% rule (25x = 4% withdrawal
                                rate)</span>
                            <span x-show="fireStrategy === 'fat'">Higher spending with more buffer, 3% withdrawal
                                rate</span>
                        </small>
                    </fieldset>
                </details>

                <footer>
                    <h2 x-text="yearsText"></h2>
                    <p x-show="isValid" x-html="explanation" style="margin-bottom: 0;"></p>
                    <p x-show="isValid && showCoastFire && currentAge && retirementAge" x-html="coastFireExplanation">
                    </p>
                    <p x-show="!isValid" style="color: var(--pico-del-color);">
                        Please enter a savings rate between 1% and 100%
                    </p>

                    <div x-show="isValid" style="margin-top: 2rem;">
                        <canvas x-ref="retirementChart"></canvas>
                    </div>

                    <table x-show="isValid && showLeanFatFire" style="margin-top: 2rem;">
                        <caption>FIRE Strategy Comparison</caption>
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Withdrawal</th>
                                <th x-show="showCoastFire && currentAge && retirementAge">Coast Target</th>
                                <th x-show="showCoastFire && currentAge && retirementAge">Years to Coast</th>
                                <th>Retire Target</th>
                                <th>Years to Retire</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr :style="fireStrategy === 'lean' ? 'font-weight: bold;' : ''">
                                <td>LeanFIRE</td>
                                <td>
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(calculatedPostTaxIncome * (1 - savingsRate)) + ' (4.5%)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0">4.5%</span>
                                </td>
                                <td x-show="showCoastFire && currentAge && retirementAge">
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(coastTargetFor(22) * calculatedPostTaxIncome * (1 - savingsRate)) + ' (' + coastTargetFor(22).toFixed(1) + 'x)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0"
                                        x-text="coastTargetFor(22).toFixed(1) + 'x'"></span>
                                </td>
                                <td x-show="showCoastFire && currentAge && retirementAge"
                                    x-text="coastGoalMetFor(22) ? 'Met ✓' : Math.round(yearsToTarget(coastTargetFor(22)))">
                                </td>
                                <td>
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(22 * calculatedPostTaxIncome * (1 - savingsRate)) + ' (22x)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0">22x</span>
                                </td>
                                <td x-text="Math.round(yearsToTarget(22)) || 'Met ✓'"></td>
                            </tr>
                            <tr :style="fireStrategy === 'standard' ? 'font-weight: bold;' : ''">
                                <td>Standard FIRE</td>
                                <td>
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(calculatedPostTaxIncome * (1 - savingsRate)) + ' (4.0%)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0">4.0%</span>
                                </td>
                                <td x-show="showCoastFire && currentAge && retirementAge">
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(coastTargetFor(25) * calculatedPostTaxIncome * (1 - savingsRate)) + ' (' + coastTargetFor(25).toFixed(1) + 'x)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0"
                                        x-text="coastTargetFor(25).toFixed(1) + 'x'"></span>
                                </td>
                                <td x-show="showCoastFire && currentAge && retirementAge"
                                    x-text="coastGoalMetFor(25) ? 'Met ✓' : Math.round(yearsToTarget(coastTargetFor(25)))">
                                </td>
                                <td>
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(25 * calculatedPostTaxIncome * (1 - savingsRate)) + ' (25x)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0">25x</span>
                                </td>
                                <td x-text="Math.round(yearsToTarget(25)) || 'Met ✓'"></td>
                            </tr>
                            <tr :style="fireStrategy === 'fat' ? 'font-weight: bold;' : ''">
                                <td>FatFIRE</td>
                                <td>
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(calculatedPostTaxIncome * (1 - savingsRate)) + ' (3.0%)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0">3.0%</span>
                                </td>
                                <td x-show="showCoastFire && currentAge && retirementAge">
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(coastTargetFor(33) * calculatedPostTaxIncome * (1 - savingsRate)) + ' (' + coastTargetFor(33).toFixed(1) + 'x)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0"
                                        x-text="coastTargetFor(33).toFixed(1) + 'x'"></span>
                                </td>
                                <td x-show="showCoastFire && currentAge && retirementAge"
                                    x-text="coastGoalMetFor(33) ? 'Met ✓' : Math.round(yearsToTarget(coastTargetFor(33)))">
                                </td>
                                <td>
                                    <span x-show="calculatedPostTaxIncome > 0"
                                        x-text="formatMoney(33 * calculatedPostTaxIncome * (1 - savingsRate)) + ' (33x)'"></span>
                                    <span x-show="calculatedPostTaxIncome === 0">33x</span>
                                </td>
                                <td x-text="Math.round(yearsToTarget(33)) || 'Met ✓'"></td>
                            </tr>
                        </tbody>
                    </table>
                </footer>
            </article>
    </main>

    <script>
        function retirementCalculator() {
            return {
                // Primary input
                savingsRatePercent: 15,

                // Income inputs (optional, for dollar-based calculations)
                preTaxIncome: null,
                taxRatePercent: null,
                filingJointly: false,

                // Financial position (optional)
                alreadySaved: 0,
                currentDebt: 0,

                // Helper functions for number formatting
                formatNumberInput(value) {
                    if (!value) return '';
                    return parseInt(value).toLocaleString('en-US');
                },

                parseNumberInput(value) {
                    if (!value) return null;
                    return parseInt(value.replace(/,/g, ''));
                },

                // Display options
                showLeanFatFire: false,
                showCoastFire: false,
                currentAge: null,
                retirementAge: 65,

                // Retirement assumptions
                fireStrategy: 'standard',
                rateOfReturnPercent: 5,
                retirementMultiplier: 25,

                // Chart instance
                chart: null,

                updateMultiplierFromStrategy() {
                    switch (this.fireStrategy) {
                        case 'lean':
                            this.retirementMultiplier = 22;
                            break;
                        case 'standard':
                            this.retirementMultiplier = 25;
                            break;
                        case 'fat':
                            this.retirementMultiplier = 33;
                            break;
                    }
                },

                get yearsUntilRetirement() {
                    if (!this.currentAge || !this.retirementAge) return 30; // Default
                    return Math.max(0, this.retirementAge - this.currentAge);
                },

                coastTargetFor(multiplier) {
                    // CoastFIRE: amount needed TODAY so growth alone reaches target by retirement
                    const r = this.rateOfReturn;
                    const years = this.yearsUntilRetirement;
                    return multiplier / Math.pow(1 + r, years);
                },

                get coastFireTarget() {
                    return this.coastTargetFor(this.retirementMultiplier || 25);
                },

                coastGoalMetFor(multiplier) {
                    const target = this.coastTargetFor(multiplier) * (1 - this.savingsRate);
                    return this.existingSavingsMultiplier >= target;
                },

                get fireStrategyName() {
                    switch (this.fireStrategy) {
                        case 'lean':
                            return 'LeanFIRE';
                        case 'standard':
                            return 'Standard FIRE';
                        case 'fat':
                            return 'FatFIRE';
                        default:
                            return 'FIRE';
                    }
                },

                get fireGoalMet() {
                    const target = this.retirementMultiplier * (1 - this.savingsRate);
                    return this.existingSavingsMultiplier >= target;
                },

                get coastFireGoalMet() {
                    const target = this.coastFireTarget * (1 - this.savingsRate);
                    return this.existingSavingsMultiplier >= target;
                },

                get coastFireAmountText() {
                    if (!this.calculatedPostTaxIncome || !this.showCoastFire) return '';
                    const annualSpending = this.calculatedPostTaxIncome * (1 - this.savingsRate);
                    const targetAmount = this.coastFireTarget * annualSpending;
                    return this.formatMoney(targetAmount);
                },

                // Tax estimation based on 2024 federal + approximate state (simplified)
                estimateTaxRate(income) {
                    if (!income || income <= 0) return 25; // Default guess

                    if (this.filingJointly) {
                        // Married filing jointly brackets (higher thresholds)
                        if (income <= 22000) return 10;
                        if (income <= 89075) return 15;
                        if (income <= 190750) return 22;
                        if (income <= 364200) return 26;
                        if (income <= 462500) return 30;
                        if (income <= 693750) return 35;
                        return 40;
                    } else {
                        // Single filer brackets
                        if (income <= 11000) return 10;
                        if (income <= 44725) return 15;
                        if (income <= 95375) return 22;
                        if (income <= 182100) return 26;
                        if (income <= 231250) return 30;
                        if (income <= 578125) return 35;
                        return 40;
                    }
                },

                get estimatedTaxRate() {
                    if (this.taxRatePercent) return this.taxRatePercent;
                    return this.estimateTaxRate(this.preTaxIncome || 0);
                },

                get calculatedPostTaxIncome() {
                    if (this.preTaxIncome && this.preTaxIncome > 0) {
                        const taxRate = this.estimatedTaxRate / 100;
                        return this.preTaxIncome * (1 - taxRate);
                    }

                    return 0;
                },

                get postTaxIncomeText() {
                    const postTax = this.calculatedPostTaxIncome;
                    if (postTax > 0) {
                        return `Post-tax income: $${postTax.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
                    }
                    return '';
                },

                get savingsRate() {
                    return (this.savingsRatePercent || 0) / 100;
                },

                get existingSavingsMultiplier() {
                    if (!this.calculatedPostTaxIncome) return 0;
                    const netPosition = (this.alreadySaved || 0) - (this.currentDebt || 0);
                    return netPosition / this.calculatedPostTaxIncome;
                },

                get netPositionText() {
                    const netPosition = (this.alreadySaved || 0) - (this.currentDebt || 0);
                    const multiplier = this.existingSavingsMultiplier;
                    const absMultiplier = Math.abs(multiplier).toFixed(2);

                    if (netPosition >= 0) {
                        return `${absMultiplier}x your annual post-tax income saved`;
                    } else {
                        return `${absMultiplier}x your annual post-tax income in debt`;
                    }
                },

                get rateOfReturn() {
                    return (this.rateOfReturnPercent || 5) / 100;
                },

                get isValid() {
                    return this.savingsRatePercent > 0 && this.savingsRatePercent <= 100;
                },

                yearsToTarget(multiplier) {
                    if (!this.isValid) return 0;

                    const S = this.savingsRate;
                    const r = this.rateOfReturn;
                    const existing = this.existingSavingsMultiplier;

                    // Target: multiplier times annual spending = multiplier * (1 - S) times annual income
                    const target = multiplier * (1 - S);

                    // If already at or past target
                    if (existing >= target) return 0;

                    // Years needed with compound interest
                    const numerator = Math.log((target * r + S) / (existing * r + S));
                    const denominator = Math.log(1 + r);

                    const years = numerator / denominator;

                    // Guard against invalid results
                    if (!isFinite(years) || years < 0) return 0;

                    return years;
                },

                get yearsToRetirement() {
                    return this.yearsToTarget(this.retirementMultiplier || 25);
                },

                get yearsText() {
                    if (!this.isValid) return 'Enter a savings rate between 1% and 100%';

                    const years = this.yearsToRetirement;
                    const roundedYears = Math.round(years * 10) / 10;

                    return `${roundedYears} years until retirement`;
                },

                get explanation() {
                    if (!this.isValid) return '';

                    const years = Math.round(this.yearsToRetirement);
                    const currentYear = new Date().getFullYear();
                    const retirementYear = currentYear + years;

                    if (years === 0) {
                        return `You've already saved enough to retire!`;
                    }

                    let message = `Saving <u>${this.savingsRatePercent}%</u> of your income`;

                    if (this.existingSavingsMultiplier && Math.abs(this.existingSavingsMultiplier) > 0.01) {
                        const absMultiplier = Math.abs(this.existingSavingsMultiplier).toFixed(1);
                        const savedDesc = this.existingSavingsMultiplier > 0
                            ? `with <u>${absMultiplier}x</u> your income already saved`
                            : `starting <u>${absMultiplier}x</u> your income in debt`;
                        message += `, ${savedDesc}`;
                    }

                    if (this.currentAge) {
                        const retirementAge = this.currentAge + years;
                        message += `, you could retire around <mark>${retirementYear}</mark> (age <mark>${retirementAge}</mark>)`;
                    } else {
                        message += `, you could retire around <mark>${retirementYear}</mark>`;
                    }

                    return message;
                },

                get coastFireExplanation() {
                    if (!this.isValid || !this.showCoastFire || !this.currentAge || !this.retirementAge) return '';

                    const targetMultiple = this.coastFireTarget.toFixed(1);
                    const retirementAge = this.retirementAge;
                    const yearsToRetirement = this.yearsUntilRetirement;
                    const currentYear = new Date().getFullYear();
                    const retirementYear = currentYear + yearsToRetirement;

                    if (this.coastFireGoalMet) {
                        return `<b>OR</b> stop saving now and coast to <mark>${retirementYear}</mark> (age <mark>${retirementAge}</mark>)`;
                    } else {
                        return `<b>OR</b> save to <u>${targetMultiple}x</u> spending then coast to <mark>${retirementYear}</mark> (age <mark>${retirementAge}</mark>)`;
                    }
                },

                formatMoney(amount) {
                    if (amount >= 1000000) {
                        return '$' + (amount / 1000000).toFixed(1) + 'M';
                    } else if (amount >= 1000) {
                        return '$' + Math.round(amount / 1000) + 'K';
                    }
                    return '$' + Math.round(amount);
                },

                get retirementAmountText() {
                    if (!this.calculatedPostTaxIncome) return '';
                    const annualSpending = this.calculatedPostTaxIncome * (1 - this.savingsRate);
                    const targetAmount = this.retirementMultiplier * annualSpending;
                    return this.formatMoney(targetAmount);
                },

                generateChartData() {
                    const S = this.savingsRate;
                    const r = this.rateOfReturn;
                    const x = this.retirementMultiplier || 25;
                    const existing = this.existingSavingsMultiplier;

                    // Target is simply the retirement multiplier
                    const target = x;

                    // CoastFIRE: Amount needed today to coast to FIRE target by retirement
                    const coastFire = this.coastFireTarget;

                    // Chart should extend to retirement age if CoastFIRE is enabled
                    let maxYears = Math.max(5, Math.ceil(this.yearsToRetirement) + 5);
                    if (this.showCoastFire && this.currentAge && this.retirementAge) {
                        maxYears = Math.max(maxYears, this.yearsUntilRetirement + 5);
                    }

                    // Ensure maxYears is valid
                    if (!isFinite(maxYears) || maxYears < 1) {
                        maxYears = 30; // Default fallback
                    }
                    const years = [];
                    const savings = [];
                    const coastingSavings = [];
                    let yearHitCoastFire = null;

                    for (let year = 0; year <= maxYears; year++) {
                        years.push(year);

                        // Main savings curve (continuing to save)
                        const compoundedExisting = existing * Math.pow(1 + r, year);
                        const accumulatedSavings = S * (Math.pow(1 + r, year) - 1) / r;
                        const totalSavings = compoundedExisting + accumulatedSavings;
                        const multiplesOfSpending = totalSavings / (1 - S);
                        savings.push(multiplesOfSpending);

                        // CoastFIRE curve (save until CoastFIRE target, then stop and coast)
                        if (this.showCoastFire) {
                            // Check if we've hit the CoastFIRE target
                            if (multiplesOfSpending >= coastFire && yearHitCoastFire === null) {
                                yearHitCoastFire = year;
                            }

                            if (yearHitCoastFire === null) {
                                // Haven't hit CoastFIRE yet, follow the savings curve
                                coastingSavings.push(multiplesOfSpending);
                            } else {
                                // Hit CoastFIRE target, now just coast (compound growth only)
                                const yearsCoasting = year - yearHitCoastFire;
                                const coastValue = coastFire * Math.pow(1 + r, yearsCoasting);
                                coastingSavings.push(coastValue);
                            }
                        }
                    }

                    return { years, savings, coastingSavings, target, coastFire };
                },

                updateChart(years, savings, coastingSavings, target, coastFire) {
                    if (!this.chart) return;

                    try {
                        // Update labels (x-axis)
                        this.chart.data.labels = years;

                        // Update main savings dataset
                        this.chart.data.datasets[0].data = savings;

                        // Update or add/remove coasting dataset
                        if (this.showCoastFire && coastingSavings.length > 0) {
                            if (this.chart.data.datasets.length > 1) {
                                // Update existing coasting dataset
                                this.chart.data.datasets[1].data = coastingSavings;
                            } else {
                                // Add coasting dataset
                                this.chart.data.datasets.push({
                                    label: 'Coast (Stop Saving)',
                                    data: coastingSavings,
                                    borderColor: 'rgb(255, 159, 64)',
                                    backgroundColor: 'rgba(255, 159, 64, 0.05)',
                                    tension: 0.1,
                                    fill: false,
                                    borderDash: [5, 5],
                                    order: 2
                                });
                            }
                        } else {
                            // Remove coasting dataset if it exists
                            if (this.chart.data.datasets.length > 1) {
                                this.chart.data.datasets.pop();
                            }
                        }

                        // Update target label
                        let targetLabel = '';
                        switch (this.fireStrategy) {
                            case 'lean':
                                targetLabel = 'LeanFIRE';
                                break;
                            case 'standard':
                                targetLabel = 'FIRE';
                                break;
                            case 'fat':
                                targetLabel = 'FatFIRE';
                                break;
                            case 'custom':
                                targetLabel = 'Target';
                                break;
                        }

                        // Update annotations
                        this.chart.options.plugins.annotation.annotations.mainTarget.yMin = target;
                        this.chart.options.plugins.annotation.annotations.mainTarget.yMax = target;
                        this.chart.options.plugins.annotation.annotations.mainTarget.label.content = `${targetLabel}: ${target.toFixed(1)}x`;

                        // Update CoastFIRE annotation
                        if (this.showCoastFire) {
                            if (!this.chart.options.plugins.annotation.annotations.coastFire) {
                                this.chart.options.plugins.annotation.annotations.coastFire = {
                                    type: 'line',
                                    yMin: coastFire,
                                    yMax: coastFire,
                                    borderColor: 'rgb(54, 162, 235)',
                                    borderWidth: 1.5,
                                    borderDash: [8, 4],
                                    label: {
                                        display: true,
                                        content: `CoastFIRE: ${coastFire.toFixed(1)}x`,
                                        position: 'start',
                                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                                        color: '#fff',
                                        font: { size: 11 }
                                    }
                                };
                            } else {
                                this.chart.options.plugins.annotation.annotations.coastFire.yMin = coastFire;
                                this.chart.options.plugins.annotation.annotations.coastFire.yMax = coastFire;
                                this.chart.options.plugins.annotation.annotations.coastFire.label.content = `CoastFIRE: ${coastFire.toFixed(1)}x`;
                            }
                        } else {
                            delete this.chart.options.plugins.annotation.annotations.coastFire;
                        }

                        // Update legend visibility
                        this.chart.options.plugins.legend.display = this.showCoastFire;

                        // Trigger update with animation disabled
                        this.chart.update({
                            duration: 0
                        });
                    } catch (error) {
                        console.error('Chart update error:', error);
                        // If update fails, destroy chart and let next call recreate it
                        if (this.chart) {
                            this.chart.destroy();
                            this.chart = null;
                        }
                    }
                },

                initChart() {
                    if (!this.$refs.retirementChart) return;

                    try {
                        // Destroy existing chart completely first
                        if (this.chart) {
                            this.chart.destroy();
                            this.chart = null;
                        }

                        // Verify canvas is still valid
                        if (!this.$refs.retirementChart || !this.$refs.retirementChart.getContext) {
                            console.warn('Canvas element not available');
                            return;
                        }

                        const ctx = this.$refs.retirementChart.getContext('2d');
                        if (!ctx) {
                            console.warn('Cannot get canvas context');
                            return;
                        }

                        const { years, savings, coastingSavings, target, coastFire } = this.generateChartData();

                        // Determine which strategy label to show on the main target line
                        let targetLabel = '';
                        if (!this.showLeanFatFire) {
                            // When not showing FIRE benchmarks, just say "Retire"
                            targetLabel = 'Retire';
                        } else {
                            // When showing benchmarks, use FIRE terminology
                            switch (this.fireStrategy) {
                                case 'lean':
                                    targetLabel = 'LeanFIRE';
                                    break;
                                case 'standard':
                                    targetLabel = 'FIRE';
                                    break;
                                case 'fat':
                                    targetLabel = 'FatFIRE';
                                    break;
                            }
                        }

                        // Build datasets
                        const datasets = [{
                            label: 'Continue Saving',
                            data: savings,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1,
                            fill: true,
                            order: 1
                        }];

                        // Add coasting curve if enabled
                        if (this.showCoastFire && coastingSavings.length > 0) {
                            datasets.push({
                                label: 'Coast (Stop Saving)',
                                data: coastingSavings,
                                borderColor: 'rgb(255, 159, 64)',
                                backgroundColor: 'rgba(255, 159, 64, 0.05)',
                                tension: 0.1,
                                fill: false,
                                borderDash: [5, 5],
                                order: 2
                            });
                        }

                        // Build annotations - show all benchmarks except the currently selected strategy
                        const annotations = {
                            mainTarget: {
                                type: 'line',
                                yMin: target,
                                yMax: target,
                                borderColor: 'rgb(255, 99, 132)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    display: true,
                                    content: `${targetLabel}: ${target.toFixed(1)}x`,
                                    position: 'end',
                                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                    color: '#fff',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                }
                            }
                        };

                        // Show CoastFIRE benchmark when enabled
                        if (this.showCoastFire) {
                            annotations.coastFire = {
                                type: 'line',
                                yMin: coastFire,
                                yMax: coastFire,
                                borderColor: 'rgb(54, 162, 235)',
                                borderWidth: 1.5,
                                borderDash: [8, 4],
                                label: {
                                    display: true,
                                    content: `CoastFIRE: ${coastFire.toFixed(1)}x`,
                                    position: 'start',
                                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                                    color: '#fff',
                                    font: {
                                        size: 11
                                    }
                                }
                            };
                        }

                        // Show LeanFIRE and FatFIRE benchmarks if checkbox is enabled
                        if (this.showLeanFatFire) {
                            // Show LeanFIRE benchmark when not the selected strategy
                            if (this.fireStrategy !== 'lean') {
                                annotations.leanFire = {
                                    type: 'line',
                                    yMin: 22,
                                    yMax: 22,
                                    borderColor: 'rgb(255, 206, 86)',
                                    borderWidth: 1.5,
                                    borderDash: [3, 3],
                                    label: {
                                        display: true,
                                        content: 'LeanFIRE: 22x',
                                        position: 'start',
                                        backgroundColor: 'rgba(255, 206, 86, 0.8)',
                                        color: '#000',
                                        font: {
                                            size: 11
                                        }
                                    }
                                };
                            }

                            // Show Standard FIRE benchmark when not the selected strategy
                            if (this.fireStrategy !== 'standard') {
                                annotations.standardFire = {
                                    type: 'line',
                                    yMin: 25,
                                    yMax: 25,
                                    borderColor: 'rgb(100, 200, 100)',
                                    borderWidth: 1.5,
                                    borderDash: [3, 3],
                                    label: {
                                        display: true,
                                        content: 'Standard FIRE: 25x',
                                        position: 'center',
                                        backgroundColor: 'rgba(100, 200, 100, 0.8)',
                                        color: '#fff',
                                        font: {
                                            size: 11
                                        }
                                    }
                                };
                            }

                            // Show FatFIRE benchmark when not the selected strategy
                            if (this.fireStrategy !== 'fat') {
                                annotations.fatFire = {
                                    type: 'line',
                                    yMin: 33,
                                    yMax: 33,
                                    borderColor: 'rgb(153, 102, 255)',
                                    borderWidth: 1.5,
                                    borderDash: [3, 3],
                                    label: {
                                        display: true,
                                        content: 'FatFIRE: 33x',
                                        position: 'start',
                                        backgroundColor: 'rgba(153, 102, 255, 0.8)',
                                        color: '#fff',
                                        font: {
                                            size: 11
                                        }
                                    }
                                };
                            }
                        }

                        this.chart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: years,
                                datasets: datasets
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                aspectRatio: 2,
                                animation: false, // Disable animations to reduce race conditions
                                plugins: {
                                    legend: {
                                        display: this.showCoastFire,
                                        position: 'top'
                                    },
                                    annotation: {
                                        annotations: annotations
                                    }
                                },
                                scales: {
                                    x: {
                                        position: 'bottom',
                                        title: {
                                            display: true,
                                            text: 'Years Until'
                                        }
                                    },
                                    x2: {
                                        position: 'top',
                                        display: this.currentAge ? true : false,
                                        title: {
                                            display: true,
                                            text: 'Age'
                                        },
                                        ticks: {
                                            callback: (value, index) => {
                                                return this.currentAge + years[index];
                                            }
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    },
                                    y: {
                                        position: 'left',
                                        title: {
                                            display: true,
                                            text: 'Multiples of Annual Spending Saved'
                                        },
                                        beginAtZero: true,
                                        ticks: {
                                            callback: (value) => {
                                                return value + '×';
                                            }
                                        }
                                    },
                                    y2: {
                                        position: 'right',
                                        display: this.calculatedPostTaxIncome > 0,
                                        title: {
                                            display: true,
                                            text: 'Amount Saved'
                                        },
                                        beginAtZero: true,
                                        ticks: {
                                            callback: (value) => {
                                                const annualSpending = this.calculatedPostTaxIncome * (1 - this.savingsRate);
                                                const dollarAmount = value * annualSpending;
                                                return this.formatMoney(dollarAmount);
                                            }
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    }
                                }
                            }
                        });
                    } catch (error) {
                        console.error('Chart initialization error:', error);
                        // Ensure chart is null if creation failed
                        this.chart = null;
                    }
                },

                init() {
                    this.$nextTick(() => {
                        if (this.isValid) {
                            this.initChart();
                        }
                    });

                    this.$watch('savingsRatePercent', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('rateOfReturnPercent', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('retirementMultiplier', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('existingSavingsMultiplier', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('showLeanFatFire', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('showCoastFire', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('currentAge', () => {
                        if (this.showCoastFire && this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('retirementAge', () => {
                        if (this.showCoastFire && this.isValid) this.$nextTick(() => this.initChart());
                    });
                    this.$watch('fireStrategy', () => {
                        if (this.isValid) this.$nextTick(() => this.initChart());
                    });
                }
            }
        }
    </script>
</body>

</html>